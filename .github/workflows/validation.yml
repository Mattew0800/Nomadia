name: GitHub PR Validations

on:
  pull_request:
    types:  [opened, synchronize]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Node
      - name:  Setup Node
        uses: actions/setup-node@v3
        with:
          node-version:  20

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Fetch base branch
      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      # 5Ô∏è‚É£ Validate branch name
      - name: Validate branch name
        id: branch-check
        run: |
          BRANCH_NAME=${{ github.head_ref }}
          if [[ "$BRANCH_NAME" == "develop" || "$BRANCH_NAME" == "main" ]]; then
            echo "Branch principal, no se valida"
            echo "branch_status=ok" >> $GITHUB_OUTPUT
            exit 0
          fi

          PATTERN="^(feature|fix|chore|docs|refactor|test|style|perf)/(frontend|backend)/[A-Z]+-[0-9]+-[a-z0-9-]+$"
          if [[ !  "$BRANCH_NAME" =~ $PATTERN ]]; then
            ERROR_MSG="Branch invalido:  $BRANCH_NAME.  Formato esperado: tipo/stack/TICKET-descripcion. Ejemplo: feature/frontend/NOM-4-login-form"
            echo "branch_status=fail" >> $GITHUB_OUTPUT
            echo "branch_error=$ERROR_MSG" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "branch_status=ok" >> $GITHUB_OUTPUT
          fi

      # 6Ô∏è‚É£ Validate commit messages (SOLO ADVERTENCIA)
      - name: Validate commits
        id:  commit-check
        continue-on-error: true
        run:  |
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:%s)
          ERRORS=""
          
          while IFS= read -r COMMIT; do
            if [[ -z "$COMMIT" ]]; then
              continue
            fi
            echo "$COMMIT" | npx --no-install commitlint --edit /dev/stdin || {
              ERRORS+="Commit invalido: $COMMIT. "
            }
          done <<< "$COMMITS"
          
          if [[ -n "$ERRORS" ]]; then
            ERRORS_TRUNCATED="${ERRORS:0:400}"
            echo "commit_status=warn" >> $GITHUB_OUTPUT
            echo "commit_error=$ERRORS_TRUNCATED" >> $GITHUB_OUTPUT
          else
            echo "commit_status=ok" >> $GITHUB_OUTPUT
          fi


      # 8Ô∏è‚É£ Comment on PR
      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        env:
          BRANCH_STATUS: ${{ steps.branch-check.outputs.branch_status }}
          BRANCH_ERROR: ${{ steps. branch-check.outputs.branch_error }}
          COMMIT_STATUS: ${{ steps.commit-check.outputs.commit_status }}
          COMMIT_ERROR: ${{ steps.commit-check.outputs. commit_error }}
          SECRET_STATUS: ${{ steps.secret-check.outputs.secret_status }}
          SECRET_ERROR: ${{ steps.secret-check.outputs.secret_error }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchStatus = process.env.BRANCH_STATUS
            const branchError = process. env.BRANCH_ERROR || ''
            const commitStatus = process. env.COMMIT_STATUS
            const commitError = process.env. COMMIT_ERROR || ''
            const secretStatus = process.env. SECRET_STATUS
            const secretError = process.env.SECRET_ERROR || ''

            let commentBody = "## üîç Resultado de validaciones\n\n"
            let hasFails = false
            let hasWarnings = false
            
            if(branchStatus === "fail") {
              commentBody += "‚ùå **Branch name**:  " + branchError + "\n\n"
              hasFails = true
            }
            
            if(commitStatus === "warn") {
              commentBody += "‚ö†Ô∏è **Commits** (advertencia): " + commitError + "\n\n"
              hasWarnings = true
            } else if(commitStatus === "fail") {
              commentBody += "‚ùå **Commits**: " + commitError + "\n\n"
              hasFails = true
            }
            
            if(secretStatus === "fail") {
              commentBody += "‚ùå **Secrets**: " + secretError + "\n\n"
              hasFails = true
            }
            
            if(! hasFails && !hasWarnings) {
              commentBody += "‚úÖ Todas las validaciones pasaron correctamente"
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            })
