name: GitHub PR Validations

on:
  pull_request:
    types:  [opened, synchronize]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Node
      - name:  Setup Node
        uses: actions/setup-node@v3
        with:
          node-version:  20

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Fetch base branch
      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      # 5Ô∏è‚É£ Validate branch name
      - name: Validate branch name
        id: branch-check
        run: |
          BRANCH_NAME=${{ github.head_ref }}
          if [[ "$BRANCH_NAME" == "develop" || "$BRANCH_NAME" == "main" ]]; then
            echo "Branch principal, no se valida"
            echo "branch_status=ok" >> $GITHUB_OUTPUT
            exit 0
          fi

          PATTERN="^(feature|fix|chore|docs|refactor|test|style|perf)/(frontend|backend)/[A-Z]+-[0-9]+-[a-z0-9-]+$"
          if [[ !  "$BRANCH_NAME" =~ $PATTERN ]]; then
            ERROR_MSG="Branch invalido:  $BRANCH_NAME.  Formato esperado: <tipo>/<stack>/<TICKET>-<descripcion>. Ejemplo: feature/frontend/NOM-4-login-form"
            echo "branch_status=fail" >> $GITHUB_OUTPUT
            echo "branch_error=$ERROR_MSG" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "branch_status=ok" >> $GITHUB_OUTPUT
          fi

      # 6Ô∏è‚É£ Validate commit messages (SOLO ADVERTENCIA)
      - name: Validate commits
        id: commit-check
        continue-on-error: true
        run: |
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:%s)
          ERRORS=""
          
          while IFS= read -r COMMIT; do
            if [[ -z "$COMMIT" ]]; then
              continue
            fi
            echo "$COMMIT" | npx --no-install commitlint --edit /dev/stdin || {
              ERRORS+="Commit invalido:  $COMMIT. "
            }
          done <<< "$COMMITS"
          
          if [[ -n "$ERRORS" ]]; then
            # Limitar a 500 caracteres para no romper el output
            ERRORS_TRUNCATED="${ERRORS:0:500}"
            echo "commit_status=warn" >> $GITHUB_OUTPUT
            echo "commit_error=$ERRORS_TRUNCATED" >> $GITHUB_OUTPUT
            # NO hacemos exit 1, solo advertencia
          else
            echo "commit_status=ok" >> $GITHUB_OUTPUT
          fi

      # 7Ô∏è‚É£ Check for secrets
      - name: Check for secrets
        id:  secret-check
        run: |
          MAX_LINES=20
          SECRETS=$(grep -RInE "API_KEY|SECRET_KEY|SECRET|password|token" . \
            --exclude-dir={node_modules,dist,build,. git,.github,coverage,__tests__,. next,out} \
            --exclude="*.lock" \
            --exclude="package-lock.json" | head -n $MAX_LINES || true)
          
          if [[ -n "$SECRETS" ]]; then
            # Contar l√≠neas
            COUNT=$(echo "$SECRETS" | wc -l)
            # Limitar a 800 caracteres
            SECRETS_TRUNCATED="${SECRETS:0:800}"
            echo "secret_status=fail" >> $GITHUB_OUTPUT
            echo "secret_error=Se detectaron $COUNT posibles secretos (mostrando max $MAX_LINES lineas): $SECRETS_TRUNCATED" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "secret_status=ok" >> $GITHUB_OUTPUT
          fi

      # 8Ô∏è‚É£ Comment on PR if any validation fails
      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets. GITHUB_TOKEN }}
          script:  |
            const branchStatus = "${{ steps.branch-check. outputs.branch_status }}"
            const branchError = "${{ steps.branch-check.outputs. branch_error }}"
            const commitStatus = "${{ steps.commit-check.outputs.commit_status }}"
            const commitError = "${{ steps.commit-check. outputs.commit_error }}"
            const secretStatus = "${{ steps.secret-check.outputs.secret_status }}"
            const secretError = "${{ steps.secret-check.outputs.secret_error }}"

            let commentBody = "## üîç Resultado de validaciones\n\n"
            let hasFails = false
            let hasWarnings = false
            
            if(branchStatus === "fail") {
              commentBody += "‚ùå **Branch name**:  " + branchError + "\n\n"
              hasFails = true
            }
            
            if(commitStatus === "warn") {
              commentBody += "‚ö†Ô∏è **Commits** (advertencia): " + commitError + "\n\n"
              hasWarnings = true
            } else if(commitStatus === "fail") {
              commentBody += "‚ùå **Commits**: " + commitError + "\n\n"
              hasFails = true
            }
            
            if(secretStatus === "fail") {
              commentBody += "‚ùå **Secrets**: " + secretError + "\n\n"
              hasFails = true
            }
            
            if(! hasFails && !hasWarnings) {
              commentBody += "‚úÖ Todas las validaciones pasaron correctamente"
            }

            github.rest.issues. createComment({
              issue_number: context. issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            })
