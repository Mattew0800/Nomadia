<app-test>

  <div class="profile-card">
    <div class="profile-header">
      <section class="profile-main">
        <div class="profile-user-profile">
          @if(user){
            <div class="user-image large">
              <img [src]="photoPreview || 'default-user-img.jpg'" alt="Foto de Usuario">
            </div>
            <div class="user-info large">
              @if(user.name){
                <h2 class="user-name">{{user.name}}</h2>
              }@else{
                <h2 class="user-name">Yo</h2>
              }
              <p class="user-status">Traveler Pro</p>
            </div>
          }
        </div>
      </section>
    </div>

    <form [formGroup]="form" (ngSubmit)="save()" novalidate>
      <div class="form-grid">
        <div>
          <label>Nombre completo</label>
          <input type="text" formControlName="name"
                 [ngClass]="{'input-invalid': form.get('name')?.invalid && form.get('name')?.touched}">

          <div>
            @if(f['name'].touched && f['name'].hasError('required')){
              <p class="formError">El nombre completo es obligatorio.</p>
            }
          </div>
          <div>
            @if(f['name'].touched && f['name'].hasError('pattern')){
              <p class="formError">Debes ingresar un nombre y apellido válidos (ej: Juan Pérez).</p>
            }
          </div>

        </div>

        <div>
          <label>Apodo</label>
          <input type="text"
                 formControlName="nick"
                 alt="Apodo"
                 maxlength="10"
                 [ngClass]="{'input-invalid': nickControl?.invalid && nickControl?.touched}">

          @if(nickControl?.touched && nickControl?.hasError("maxlength")){
            <p class="formError">El apodo no puede exceder los 10 caracteres.</p>
          }
        </div>

        <div>
          <label>Email</label>
          <input type="email"
                 formControlName="email"
                 maxlength="50"
                 [ngClass]="{'input-invalid': emailControl?.invalid && emailControl?.touched}">

          @if(emailControl?.touched && emailControl?.hasError('required')){
            <p class="formError">El email es obligatorio.</p>
          }
          @if(emailControl?.touched && emailControl?.hasError('email')){
            <p class="formError">El formato del email es inválido (ej: usuario&#64;dominio.com).</p>
          }


        </div>

        <div>
          <label>Teléfono</label>
          <input type="text"
                 formControlName="phone"
                 maxlength="13"
                 pattern="[0-9]*"
                 title="Solo números"
                 [ngClass]="{'input-invalid': phoneControl?.invalid && phoneControl?.touched}">


          @if(phoneControl?.touched){
            @if(phoneControl?.hasError("required")){

              <p class="formError">El teléfono es obligatorio.</p>

            }
            @if(phoneControl?.hasError("minlength")){
              <p class="formError">El teléfono debe tener al menos 10 dígitos.</p>
            }
            @if(phoneControl?.hasError("maxlength")){
              <p class="formError">El teléfono no puede tener más de 13 dígitos.</p>
            }
            @if(phoneControl?.hasError("pattern")){
              <p class="formError">El teléfono solo puede contener números.</p>
            }
          }
        </div>

        <div>
          <label>Fecha de nacimiento</label>
          <input type="date" formControlName="birth" [min]="getMinDate()" [max]="getMaxDate()" [ngClass]="{'input-invalid': f['birth'].invalid && f['birth'].touched}">

          @if(f['birth'].errors?.['pattern'] && f['birth'].touched){
            <p class="formError">La fecha debe tener formato YYYY-MM-DD con año de 4 dígitos.</p>
          }@else if(f['birth'].touched && f['birth'].hasError('futureDate')){
            <p class="formError">La fecha de nacimiento no puede ser futura.</p>
          }@else if(f['birth'].touched && f['birth'].hasError('isUnderage')){
            <p class="formError">Debes tener al menos 8 años.</p>
          }@else if(f['birth'].touched && f['birth'].hasError('isTooOld')){
            <p class="formError">La fecha de nacimiento es incorrecta.</p>
          }

        </div>


        <div>
          <label>Edad</label>
          <input type="number" formControlName="age" readonly>
        </div>

        <div id="form__grid-aboutme">
          <label>Sobre mí</label>
          <textarea formControlName="about" rows="4" maxlength="100" [ngClass]="{'input-invalid':f['about'].invalid && f['about'].touched}"></textarea>

          @if(aboutControl?.touched){
            @if(aboutControl?.hasError("maxlength")){
              <p class="formError">La descripción no puede exceder los 100 caracteres.</p>
            }
            @if(aboutControl?.hasError("minlength")){
              <p class="formError">La descripción debe tener 3 caracteres como minimo.</p>
            }
          }
        </div>

        <div>
          <label>Foto de perfil</label>
          <input type="file" #fileInput accept="image/*" (change)="onSelectPhoto($event)">
          <div style="margin-top:.5rem; display:flex; gap:.75rem; align-items:center;">
            <ng-container *ngIf="photoPreview">
              <img [src]="photoPreview" alt="preview"
                   style="width:64px;height:64px;border-radius:12px;object-fit:cover;">
              <button type="button" class="filters-btn" (click)="removePhoto()">
                Quitar foto
              </button>
            </ng-container>
          </div>
        </div>

        <div style="grid-column:1/3;">
          <label style="display:block;margin-bottom:.5rem;">Cambiar contraseña (opcional)</label>
          <div class="form-grid" style="grid-template-columns:1fr 1fr;">
            <div>
              <label>Contraseña actual</label>
              <input type="password" formControlName="currentPass">
            </div>

            <div>
              <label>Nueva contraseña</label>
              <input type="password" formControlName="newPass"
                     [ngClass]="{'input-invalid': form.get('newPass')?.invalid && form.get('newPass')?.touched}">
              <div *ngIf="newPassControl?.touched && newPassControl?.hasError('minlength')">
                <p class="formError">La contraseña debe tener al menos 6 caracteres.</p>
              </div>
            </div>

            <div style="grid-column:1/3;">
              <label>Confirmar nueva contraseña</label>
              <input type="password" formControlName="confirmPass"
                     [ngClass]="{'input-invalid': !passwordsMatch() && form.get('confirmPass')?.touched}">
              <p *ngIf="!passwordsMatch()" class="formError" style="margin-top:.25rem;">
                Las contraseñas no coinciden.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex; gap:1rem; margin-top:2rem;">
        <button class="edit-btn" type="submit">Guardar cambios</button>
        <button class="filters-btn" type="button" (click)="cancel()">Volver</button>
      </div>

      <div *ngFor="let key of (errorMessages | keyvalue)" class="formError" id="profileEditError">
        <strong>{{ key.key }}:</strong> {{ key.value }}
      </div>


      <p *ngIf="msgOk" style="margin-top:1rem; color:#d1f366;">{{ msgOk }}</p>
      <p *ngIf="msgError" style="margin-top:1rem; color:#eb3f3a;">{{ msgError }}</p>
    </form>

  </div>
</app-test>
